# Complete Laravel Project Deployment Guide with Database Setup

This guide covers deploying a Laravel project to a VPS with Nginx, PHP, and database configuration.

---

## **1️⃣ Update & Install Required Packages**

In your VS Code terminal (connected to the VPS):

```bash
sudo apt update && sudo apt upgrade -y
sudo apt install nginx php-cli php-mbstring php-xml php-bcmath unzip curl git -y
```

---

## **2️⃣ Install PHP-FPM (for Laravel)**

Laravel needs PHP running through **PHP-FPM**:

```bash
sudo apt install php-fpm php-mysql -y
```

Check your PHP version:
```bash
php --version
```

---

## **3️⃣ Install Database Server (MariaDB/MySQL)**

Install MariaDB:
```bash
sudo apt install mariadb-server -y
sudo systemctl start mariadb
sudo systemctl enable mariadb
```

Secure the installation:
```bash
sudo mysql_secure_installation
```

---

## **4️⃣ Configure Database**

### Access MariaDB as root:
```bash
sudo mysql -u root -p
```

### Create database and user:
```sql
-- Create database
CREATE DATABASE laravel_db;

-- Create user with strong password
CREATE USER 'laravel_user'@'localhost' IDENTIFIED BY 'StrongPassword123!';

-- Grant privileges
GRANT ALL PRIVILEGES ON laravel_db.* TO 'laravel_user'@'localhost';

-- Flush privileges
FLUSH PRIVILEGES;

-- Exit
EXIT;
```

### If using custom MariaDB installation path:
```bash
sudo /usr/local/apps/mariadb1011/bin/mysql -u root -p
```

### Reset root password if needed:
```sql
-- Flush privileges
FLUSH PRIVILEGES;

-- Update root password for localhost
ALTER USER 'root'@'localhost' IDENTIFIED BY 'your_new_strong_password';

-- Flush again
FLUSH PRIVILEGES;

-- Exit
EXIT;
```

---

## **5️⃣ Install Composer**

```bash
curl -sS https://getcomposer.org/installer | php
sudo mv composer.phar /usr/local/bin/composer
composer --version
```

---

## **6️⃣ Upload Laravel Project to Server**

You have two main options:

### **Option A:** Clone from GitHub
```bash
cd /var/www
sudo git clone https://github.com/yourusername/yourlaravelproject.git laravel-app
```

### **Option B:** Upload via VS Code
- Use VS Code's file explorer to drag and drop your Laravel project into `/var/www/laravel-app`

---

## **7️⃣ Set Permissions**

```bash
sudo chown -R www-data:www-data /var/www/laravel-app
sudo chmod -R 755 /var/www/laravel-app
sudo chmod -R 775 /var/www/laravel-app/storage
sudo chmod -R 775 /var/www/laravel-app/bootstrap/cache
```

---

## **8️⃣ Install Laravel Dependencies**

```bash
cd /var/www/laravel-app
sudo -u www-data composer install --no-dev --optimize-autoloader
```

---

## **9️⃣ Configure Laravel Environment**

```bash
cd /var/www/laravel-app
cp .env.example .env
sudo -u www-data php artisan key:generate
```

### Edit the `.env` file:
```bash
sudo nano .env
```

Update database credentials:
```env
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=laravel_db
DB_USERNAME=laravel_user
DB_PASSWORD=StrongPassword123!

APP_ENV=production
APP_DEBUG=false
APP_URL=http://your_domain.com
```

---

## **🔟 Run Laravel Database Setup**

```bash
cd /var/www/laravel-app

# Test database connection
sudo -u www-data php artisan tinker --execute="DB::connection()->getPdo();"

# Run migrations
sudo -u www-data php artisan migrate

# Clear and cache config (for production)
sudo -u www-data php artisan config:clear
sudo -u www-data php artisan config:cache
sudo -u www-data php artisan route:cache
sudo -u www-data php artisan view:cache
```

---

## **1️⃣1️⃣ Configure Nginx for Laravel**

Get your PHP version:
```bash
php --version
# Note the version (e.g., 8.1, 8.2, etc.)
```

Create Nginx configuration:
```bash
sudo nano /etc/nginx/sites-available/laravel
```

Paste this configuration (adjust PHP version if needed):
```nginx
server {
    listen 80;
    server_name your_domain.com www.your_domain.com;
    root /var/www/laravel-app/public;
    index index.php index.html;

    # Security headers
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-XSS-Protection "1; mode=block";

    # Laravel routes
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # PHP processing
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;  # Adjust PHP version
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_hide_header X-Powered-By;
    }

    # Deny access to hidden files
    location ~ /\. {
        deny all;
    }

    # Optimize static files
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

---

## **1️⃣2️⃣ Enable Site & Test Configuration**

```bash
# Enable the site
sudo ln -s /etc/nginx/sites-available/laravel /etc/nginx/sites-enabled/

# Remove default site (optional)
sudo rm /etc/nginx/sites-enabled/default

# Test Nginx configuration
sudo nginx -t

# Restart services
sudo systemctl restart nginx
sudo systemctl restart php8.1-fpm  # Adjust PHP version
```

---

## **1️⃣3️⃣ Point Domain to VPS**

1. Go to your domain registrar's DNS settings
2. Create an **A record**:
   - Name: `@` (for root domain)
   - Value: `your_vps_ip_address`
3. Create a **CNAME record** (optional):
   - Name: `www`
   - Value: `your_domain.com`
4. Wait 5-30 minutes for DNS propagation

---

## **1️⃣4️⃣ Test Your Laravel Application**

```bash
# Check if services are running
sudo systemctl status nginx
sudo systemctl status php8.1-fpm
sudo systemctl status mariadb

# Test Laravel installation
curl -I http://your_domain.com
```

---

## **1️⃣5️⃣ Enable HTTPS with Let's Encrypt (Recommended)**

```bash
# Install Certbot
sudo apt install certbot python3-certbot-nginx -y

# Get SSL certificate
sudo certbot --nginx -d your_domain.com -d www.your_domain.com

# Test auto-renewal
sudo certbot renew --dry-run
```

---

## **🔧 Troubleshooting Commands**

### Check logs if something goes wrong:
```bash
# Nginx error logs
sudo tail -f /var/log/nginx/error.log

# Laravel logs
sudo tail -f /var/www/laravel-app/storage/logs/laravel.log

# PHP-FPM logs
sudo tail -f /var/log/php8.1-fpm.log
```

### Common issues:
```bash
# If permissions are wrong
sudo chown -R www-data:www-data /var/www/laravel-app
sudo chmod -R 755 /var/www/laravel-app/storage

# If composer fails
cd /var/www/laravel-app
sudo -u www-data composer install

# If database connection fails
sudo -u www-data php artisan tinker --execute="DB::connection()->getPdo();"
```

---

## **🎉 Final Checklist**

- ✅ Domain points to VPS IP
- ✅ Nginx is running and configured
- ✅ PHP-FPM is running
- ✅ Database is created and accessible
- ✅ Laravel `.env` configured
- ✅ Migrations completed
- ✅ Permissions set correctly
- ✅ SSL certificate installed (optional but recommended)

Your Laravel application should now be live at `https://your_domain.com`!
