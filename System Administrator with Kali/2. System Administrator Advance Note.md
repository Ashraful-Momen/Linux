### Load Balancing and High Availability

#### HAProxy Configuration
```bash
# Install HAProxy
apt install haproxy

# Configuration /etc/haproxy/haproxy.cfg
global
    log /dev/log local0
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000

frontend web_frontend
    bind *:80
    stats uri /haproxy?stats
    default_backend web_servers

backend web_servers
    balance roundrobin
    option httpchk GET /health
    server web1 192.168.1.20:80 check
    server web2 192.168.1.21:80 check
    server web3 192.168.1.22:80 check

# HAProxy management
haproxy -c -f /etc/haproxy/haproxy.cfg  # Check config
systemctl reload haproxy                  # Reload
echo "show stat" | socat /run/haproxy/admin.sock stdio
```

#### Keepalived for HA
```bash
# Install Keepalived
apt install keepalived

# Configuration /etc/keepalived/keepalived.conf
vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 51
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass secretpass
    }
    virtual_ipaddress {
        192.168.1.100/24
    }
}

# Health check script
vrrp_script check_nginx {
    script "/usr/bin/killall -0 nginx"
    interval 2
    weight 2
}
```

### Automation and Configuration Management

#### Ansible Basics
```bash
# Install Ansible
apt install ansible

# Inventory file /etc/ansible/hosts
[webservers]
web1.example.com
web2.example.com

[dbservers]
db1.example.com

[all:vars]
ansible_user=admin
ansible_ssh_private_key_file=/home/admin/.ssh/id_rsa

# Basic playbook example
# webserver.yml
---
- hosts: webservers
  become: yes
  tasks:
    - name: Install nginx
      apt:
        name: nginx
        state: present
    
    - name: Start nginx
      service:
        name: nginx
        state: started
        enabled: yes
    
    - name: Copy website files
      copy:
        src: /local/path/
        dest: /var/www/html/
        owner: www-data
        group: www-data

# Run playbook
ansible-playbook webserver.yml
ansible all -m ping                     # Test connectivity
ansible webservers -a "df -h"           # Ad-hoc command
```

#### Cron Job Management
```bash
# System crontab
/etc/crontab                            # System-wide crontab
/etc/cron.d/                            # Drop-in cron files
/etc/cron.{hourly,daily,weekly,monthly}/ # Periodic scripts

# User crontab
crontab -e                              # Edit user crontab
crontab -l                              # List user crontab
crontab -r                              # Remove user crontab

# Cron syntax
# * * * * * command
# │ │ │ │ │
# │ │ │ │ └── Day of week (0-7)
# │ │ │ └──── Month (1-12)
# │ │ └────── Day of month (1-31)
# │ └──────── Hour (0-23)
# └────────── Minute (0-59)

# Examples
0 2 * * * /backup/script.sh             # Daily at 2 AM
*/15 * * * * /monitor/check.sh          # Every 15 minutes
0 */4 * * * /maintenance/clean.sh       # Every 4 hours
@reboot /startup/script.sh              # At system startup
@daily /backup/daily.sh                 # Once daily

# Logging cron output
* * * * * /path/to/script.sh >> /var/log/cron.log 2>&1
```

### Cloud Integration

#### AWS CLI
```bash
# Install AWS CLI
apt install awscli

# Configure AWS
aws configure
# Enter: Access Key ID, Secret Access Key, Region, Output format

# S3 operations
aws s3 ls                               # List buckets
aws s3 cp file.txt s3://bucket/         # Upload file
aws s3 sync /local/dir s3://bucket/     # Sync directory
aws s3 rm s3://bucket/file.txt          # Delete file

# EC2 operations
aws ec2 describe-instances              # List instances
aws ec2 start-instances --instance-ids i-1234567890
aws ec2 stop-instances --instance-ids i-1234567890

# Backup to S3 script
#!/bin/bash
DATE=$(date +%Y%m%d)
BACKUP_DIR="/backup"
S3_BUCKET="s3://mybackup-bucket"

tar -czf $BACKUP_DIR/backup-$DATE.tar.gz /var/www /etc
aws s3 cp $BACKUP_DIR/backup-$DATE.tar.gz $S3_BUCKET/
aws s3 ls $S3_BUCKET/ | awk '{print $4}' | grep backup- | \
    head -n -30 | xargs -I {} aws s3 rm $S3_BUCKET/{}
```

### VPN Server Setup

#### OpenVPN
```bash
# Install OpenVPN and Easy-RSA
apt install openvpn easy-rsa

# Setup PKI
make-cadir ~/openvpn-ca
cd ~/openvpn-ca
./easyrsa init-pki
./easyrsa build-ca
./easyrsa gen-dh
./easyrsa build-server-full server nopass
./easyrsa build-client-full client1 nopass

# Server configuration /etc/openvpn/server.conf
port 1194
proto udp
dev tun
ca ca.crt
cert server.crt
key server.key
dh dh.pem
server 10.8.0.0 255.255.255.0
push "redirect-gateway def1 bypass-dhcp"
push "dhcp-option DNS 8.8.8.8"
keepalive 10 120
cipher AES-256-CBC
user nobody
group nogroup
persist-key
persist-tun
status /var/log/openvpn-status.log

# Enable IP forwarding
echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
sysctl -p

# Start OpenVPN
systemctl start openvpn@server
systemctl enable openvpn@server
```

#### WireGuard
```bash
# Install WireGuard
apt install wireguard

# Generate keys
wg genkey | tee privatekey | wg pubkey > publickey

# Server configuration /etc/wireguard/wg0.conf
[Interface]
Address = 10.0.0.1/24
PrivateKey = <server-private-key>
ListenPort = 51820

[Peer]
PublicKey = <client-public-key>
AllowedIPs = 10.0.0.2/32

# Start WireGuard
wg-quick up wg0
systemctl enable wg-quick@wg0
```

### Virtualization

#### KVM/QEMU
```bash
# Install KVM
apt install qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils virt-manager

# Check virtualization support
egrep -c '(vmx|svm)' /proc/cpuinfo
kvm-ok

# Manage VMs with virsh
virsh list --all                        # List all VMs
virsh start vm-name                     # Start VM
virsh shutdown vm-name                  # Graceful shutdown
virsh destroy vm-name                   # Force stop
virsh autostart vm-name                 # Enable autostart

# Create VM
virt-install \
  --name ubuntu-vm \
  --ram 2048 \
  --disk path=/var/lib/libvirt/images/ubuntu.qcow2,size=20 \
  --vcpus 2 \
  --os-type linux \
  --os-variant ubuntu20.04 \
  --network bridge=virbr0 \
  --graphics none \
  --console pty,target_type=serial \
  --cdrom /path/to/ubuntu.iso

# Snapshot management
virsh snapshot-create-as vm-name snapshot1
virsh snapshot-list vm-name
virsh snapshot-revert vm-name snapshot1
```

### Advanced Security

#### Intrusion Detection System (IDS)
```bash
# Install Snort
apt install snort

# Configure Snort /etc/snort/snort.conf
var HOME_NET 192.168.1.0/24
var EXTERNAL_NET !$HOME_NET
include $RULE_PATH/local.rules

# Run Snort
snort -D -i eth0 -c /etc/snort/snort.conf
snort -A console -i eth0 -c /etc/snort/snort.conf  # Console mode

# AIDE (File Integrity)
apt install aide
aide --init                             # Initialize database
cp /var/lib/aide/aide.db.new /var/lib/aide/aide.db
aide --check                            # Check for changes
```

#### Fail2ban Configuration
```bash
# Install Fail2ban
apt install fail2ban

# Configuration /etc/fail2ban/jail.local
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 5

[sshd]
enabled = true
port = ssh
logpath = %(sshd_log)s
maxretry = 3

[nginx-http-auth]
enabled = true
port = http,https
logpath = %(nginx_error_log)s

[apache-auth]
enabled = true
port = http,https
logpath = %(apache_error_log)s

# Fail2ban management
fail2ban-client status                  # Overall status
fail2ban-client status sshd             # Jail status
fail2ban-client set sshd unbanip IP     # Unban IP
```

### Performance Tuning

#### Kernel Parameters
```bash
# Network tuning /etc/sysctl.conf
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.ipv4.tcp_rmem = 4096 87380 134217728
net.ipv4.tcp_wmem = 4096 65536 134217728
net.ipv4.tcp_congestion_control = bbr
net.core.netdev_max_backlog = 5000
net.ipv4.tcp_fastopen = 3

# File system tuning
vm.swappiness = 10
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5

# Apply changes
sysctl -p
```

#### Database Optimization
```bash
# MySQL/MariaDB tuning /etc/mysql/my.cnf
[mysqld]
innodb_buffer_pool_size = 1G
innodb_log_file_size = 256M
innodb_flush_log_at_trx_commit = 2
innodb_flush_method = O_DIRECT
query_cache_type = 1
query_cache_size = 256M
max_connections = 500
thread_cache_size = 50
table_open_cache = 4000

# PostgreSQL tuning /etc/postgresql/*/main/postgresql.conf
shared_buffers = 256MB
effective_cache_size = 1GB
maintenance_work_mem = 64MB
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 100
random_page_cost = 1.1
effective_io_concurrency = 200
work_mem = 4MB
min_wal_size = 1GB
max_wal_size = 4GB# Complete Bash Guide for System Administrators - Kali Linux

## Table of Contents
1. [Bash Fundamentals](#bash-fundamentals)
2. [File System Navigation & Management](#file-system-navigation--management)
3. [User & Permission Management](#user--permission-management)
4. [Process Management](#process-management)
5. [Network Administration](#network-administration)
6. [Package Management](#package-management)
7. [System Monitoring & Performance](#system-monitoring--performance)
8. [Shell Scripting](#shell-scripting)
9. [Security & Hardening](#security--hardening)
10. [Backup & Recovery](#backup--recovery)
11. [Log Management](#log-management)
12. [Advanced Techniques](#advanced-techniques)

## Bash Fundamentals

### Shell Basics
```bash
# Check current shell
echo $SHELL
echo $0

# Shell types
bash          # Bourne Again Shell
sh            # Bourne Shell
zsh           # Z Shell
dash          # Debian Almquist Shell

# Shell configuration files
~/.bashrc     # User-specific bash config
~/.profile    # User environment variables
/etc/bash.bashrc  # System-wide bash config
/etc/profile  # System-wide environment
```

### Command Structure
```bash
command [options] [arguments]

# Examples
ls -la /home
grep -i "pattern" file.txt
find / -name "*.conf" -type f
```

### Variables & Environment
```bash
# Variable assignment
VAR="value"
readonly CONSTANT="unchangeable"

# Environment variables
export PATH="$PATH:/new/path"
export EDITOR=vim
export LANG=en_US.UTF-8

# Special variables
$0    # Script name
$1-9  # Positional parameters
$#    # Number of arguments
$@    # All arguments
$?    # Exit status of last command
$$    # Current process ID
$!    # PID of last background process
```

### Input/Output Redirection
```bash
# Standard streams
# 0 = stdin, 1 = stdout, 2 = stderr

# Output redirection
command > file      # Redirect stdout (overwrite)
command >> file     # Redirect stdout (append)
command 2> file     # Redirect stderr
command &> file     # Redirect both stdout and stderr
command 2>&1        # Redirect stderr to stdout

# Input redirection
command < file      # Read input from file
command << EOF      # Here document
content
EOF

# Pipes
command1 | command2 # Pipe output of command1 to command2
command1 |& command2 # Pipe stdout and stderr
```

## File System Navigation & Management

### Navigation Commands
```bash
pwd               # Print working directory
cd /path/to/dir   # Change directory
cd ~              # Go to home directory
cd -              # Go to previous directory
cd ..             # Go up one level

# Listing files
ls -la            # List all files with details
ls -lh            # Human-readable sizes
ls -lt            # Sort by time
ls -lS            # Sort by size
ls -R             # Recursive listing
```

### File Operations
```bash
# Creating files/directories
touch file.txt           # Create empty file
mkdir directory          # Create directory
mkdir -p path/to/dir     # Create nested directories
mktemp                   # Create temporary file

# Copying/Moving
cp source dest           # Copy file
cp -r source dest        # Copy directory recursively
cp -p source dest        # Preserve attributes
mv source dest           # Move/rename

# Removing
rm file                  # Remove file
rm -rf directory         # Remove directory forcefully
rmdir directory          # Remove empty directory

# Links
ln -s target link        # Create symbolic link
ln target link           # Create hard link
```

### File Information
```bash
file filename           # Determine file type
stat filename           # Detailed file information
du -sh directory        # Directory size
df -h                   # Disk usage
lsof                    # List open files
lsof -p PID            # Files opened by process
lsof -i :PORT          # Process using port
```

### Finding Files
```bash
# find command
find / -name "filename"              # Find by name
find / -type f -name "*.log"         # Find files by pattern
find / -type d -name "dir*"          # Find directories
find / -user username                # Find by owner
find / -group groupname              # Find by group
find / -perm 644                     # Find by permissions
find / -size +100M                   # Find by size
find / -mtime -7                     # Modified in last 7 days
find / -exec command {} \;           # Execute command on results

# locate command (faster, uses database)
updatedb                             # Update database
locate filename                      # Find file

# which/whereis
which command                        # Find command location
whereis command                      # Find binary, source, manual
```

## User & Permission Management

### User Management
```bash
# User operations
useradd username                     # Add user
useradd -m -s /bin/bash username     # Add user with home and shell
usermod -aG group username           # Add user to group
usermod -L username                  # Lock user
usermod -U username                  # Unlock user
userdel username                     # Delete user
userdel -r username                  # Delete user and home

# Password management
passwd username                      # Change password
chage -l username                    # View password aging
chage -E 2025-12-31 username       # Set expiration date

# User information
id username                          # User and group IDs
whoami                              # Current username
who                                 # Logged in users
w                                   # Detailed user activity
last                                # Login history
lastlog                             # Last login times
```

### Group Management
```bash
groupadd groupname                   # Add group
groupmod -n newname oldname          # Rename group
groupdel groupname                   # Delete group
groups username                      # Show user's groups
gpasswd -a user group               # Add user to group
gpasswd -d user group               # Remove user from group
```

### Permissions
```bash
# Permission structure: rwxrwxrwx (owner|group|others)
# r=4, w=2, x=1

# Changing permissions
chmod 755 file                       # Numeric mode
chmod u+x file                       # Symbolic mode
chmod -R 644 directory              # Recursive
chmod u=rwx,g=rx,o=r file          # Detailed symbolic

# Changing ownership
chown user:group file               # Change owner and group
chown -R user:group directory       # Recursive
chgrp group file                    # Change group only

# Special permissions
chmod u+s file                      # Set SUID
chmod g+s directory                 # Set SGID
chmod +t directory                  # Set sticky bit

# Default permissions
umask                               # View current umask
umask 022                           # Set umask
```

### Sudo Configuration
```bash
# Edit sudoers file
visudo                              # Safe way to edit

# Sudoers syntax
username ALL=(ALL:ALL) ALL          # Full sudo access
username ALL=(ALL) NOPASSWD: ALL    # No password required
%groupname ALL=(ALL:ALL) ALL        # Group access

# Sudo usage
sudo command                        # Run as root
sudo -u user command                # Run as specific user
sudo -i                             # Interactive root shell
sudo -l                             # List sudo privileges
```

## Process Management

### Process Control
```bash
# Viewing processes
ps aux                              # All processes
ps -ef                              # Full format
ps -u username                      # User's processes
pstree                              # Process tree
top                                 # Interactive process viewer
htop                                # Enhanced top

# Process information
pgrep processname                   # Find process ID
pidof processname                   # Get PID
lsof -p PID                        # Files used by process

# Killing processes
kill PID                            # Terminate process
kill -9 PID                         # Force kill
killall processname                 # Kill by name
pkill pattern                       # Kill by pattern
```

### Job Control
```bash
# Background/Foreground
command &                           # Run in background
jobs                                # List jobs
fg %1                               # Bring job to foreground
bg %1                               # Send job to background
disown %1                           # Detach job from shell

# Process priority
nice -n 10 command                  # Run with nice value
renice -n 5 -p PID                  # Change priority
```

### System Services
```bash
# systemd (modern systems)
systemctl start service             # Start service
systemctl stop service              # Stop service
systemctl restart service           # Restart service
systemctl status service            # Check status
systemctl enable service            # Enable at boot
systemctl disable service           # Disable at boot
systemctl list-units                # List all units
systemctl list-unit-files           # List unit files
journalctl -u service               # View service logs
journalctl -f                       # Follow system logs

# Traditional init
service service_name start          # Start service
service service_name stop           # Stop service
service --status-all                # List all services
```

## Network Administration

### Network Configuration
```bash
# Interface management
ip addr show                        # Show IP addresses
ip link show                        # Show interfaces
ip link set eth0 up/down           # Enable/disable interface
ip addr add 192.168.1.10/24 dev eth0  # Add IP
ip route show                       # Show routing table
ip route add default via 192.168.1.1  # Add default route

# Legacy commands (still useful)
ifconfig                            # Show/configure interfaces
route -n                            # Show routing table

# DNS configuration
cat /etc/resolv.conf               # DNS servers
dig domain.com                     # DNS lookup
nslookup domain.com                # DNS query
host domain.com                    # DNS lookup
```

### Network Tools
```bash
# Connectivity testing
ping -c 4 host                     # Ping with count
traceroute host                    # Trace route
mtr host                           # Combined ping/traceroute

# Port scanning (Kali specialty)
nmap -sV host                      # Service version scan
nmap -sS host                      # SYN scan
nmap -p- host                      # All ports
nmap -sn network/24                # Ping sweep
masscan -p1-65535 host             # Fast port scanner

# Network analysis
netstat -tuln                      # Listening ports
ss -tuln                           # Socket statistics
lsof -i :port                      # Process using port
tcpdump -i eth0                    # Packet capture
tcpdump -w file.pcap               # Save capture
wireshark                          # GUI packet analyzer

# File transfer
wget URL                           # Download file
curl -O URL                        # Download file
scp file user@host:/path           # Secure copy
rsync -avz source dest             # Sync files
```

### Firewall Management
```bash
# iptables
iptables -L                        # List rules
iptables -A INPUT -p tcp --dport 22 -j ACCEPT  # Allow SSH
iptables -A INPUT -j DROP          # Drop all other input
iptables-save > /etc/iptables/rules.v4  # Save rules
iptables-restore < /etc/iptables/rules.v4  # Restore rules

# ufw (simplified firewall)
ufw enable                         # Enable firewall
ufw status                         # Check status
ufw allow 22/tcp                   # Allow SSH
ufw deny 80/tcp                    # Deny HTTP
```

## Package Management

### APT (Debian/Kali)
```bash
# Update system
apt update                         # Update package lists
apt upgrade                        # Upgrade packages
apt full-upgrade                   # Full system upgrade
apt dist-upgrade                   # Distribution upgrade

# Package operations
apt install package                # Install package
apt remove package                 # Remove package
apt purge package                  # Remove with config
apt autoremove                     # Remove unused deps
apt search keyword                 # Search packages
apt show package                   # Package information
apt list --installed               # List installed

# Package cache
apt clean                          # Clean package cache
apt autoclean                      # Clean old packages

# Repository management
add-apt-repository ppa:repo        # Add repository
apt-add-repository 'deb URL dist comp'  # Add custom repo
```

### DPKG (Low-level)
```bash
dpkg -i package.deb                # Install .deb file
dpkg -r package                    # Remove package
dpkg -l                            # List installed
dpkg -L package                    # List package files
dpkg -S /path/to/file             # Find package owning file
dpkg --configure -a                # Configure pending
```

## System Monitoring & Performance

### System Information
```bash
# Hardware information
lscpu                              # CPU information
lsmem                              # Memory information
lsblk                              # Block devices
lspci                              # PCI devices
lsusb                              # USB devices
dmidecode                          # DMI/SMBIOS info

# System statistics
uptime                             # System uptime
free -h                            # Memory usage
vmstat 1                           # Virtual memory stats
iostat -x 1                        # I/O statistics
mpstat 1                           # CPU statistics
sar                                # System activity
```

### Resource Monitoring
```bash
# Real-time monitoring
top                                # Process monitor
htop                               # Enhanced top
iotop                              # I/O monitor
iftop                              # Network monitor
nethogs                            # Network usage by process
atop                               # Advanced system monitor

# Disk usage
df -h                              # Filesystem usage
du -sh *                           # Directory sizes
ncdu                               # NCurses disk usage
```

### Performance Analysis
```bash
# CPU profiling
perf top                           # Real-time CPU profile
perf record command                # Record performance
perf report                        # Analyze recording

# System calls
strace command                     # Trace system calls
strace -p PID                      # Trace running process
ltrace command                     # Trace library calls

# File access
lsof                               # List open files
fuser -v /path                     # Processes using path
```

## Shell Scripting

### Script Basics
```bash
#!/bin/bash
# Shebang line - specifies interpreter

# Make script executable
chmod +x script.sh

# Run script
./script.sh
bash script.sh
source script.sh  # Run in current shell
```

### Variables & Arrays
```bash
# Variables
NAME="value"
readonly CONST="unchangeable"
unset NAME

# Command substitution
DATE=$(date)
DATE=`date`  # Backticks (older style)

# Arrays
ARRAY=(one two three)
ARRAY[3]="four"
echo ${ARRAY[0]}           # First element
echo ${ARRAY[@]}           # All elements
echo ${#ARRAY[@]}          # Array length

# Associative arrays
declare -A HASH
HASH[key]="value"
echo ${HASH[key]}
```

### Control Structures
```bash
# If statement
if [ condition ]; then
    commands
elif [ condition ]; then
    commands
else
    commands
fi

# Test operators
-eq  # Equal (numeric)
-ne  # Not equal (numeric)
-lt  # Less than
-gt  # Greater than
-le  # Less than or equal
-ge  # Greater than or equal
=    # Equal (string)
!=   # Not equal (string)
-z   # Zero length string
-n   # Non-zero length string
-e   # File exists
-f   # Regular file
-d   # Directory
-r   # Readable
-w   # Writable
-x   # Executable

# Case statement
case $VAR in
    pattern1)
        commands
        ;;
    pattern2|pattern3)
        commands
        ;;
    *)
        default commands
        ;;
esac

# Loops
# For loop
for i in {1..10}; do
    echo $i
done

for file in *.txt; do
    echo $file
done

# While loop
while [ condition ]; do
    commands
done

# Until loop
until [ condition ]; do
    commands
done

# Loop control
break     # Exit loop
continue  # Skip iteration
```

### Functions
```bash
# Function definition
function_name() {
    local VAR="local variable"
    echo "Arguments: $@"
    echo "First arg: $1"
    return 0  # Return status
}

# Alternative syntax
function function_name {
    commands
}

# Calling functions
function_name arg1 arg2
RESULT=$?  # Get return status
```

### Input/Output
```bash
# Reading input
read -p "Enter value: " VAR
read -s -p "Password: " PASS  # Silent input
read -t 5 VAR  # Timeout

# Select menu
select OPTION in "Option1" "Option2" "Quit"; do
    case $OPTION in
        "Option1") echo "Selected 1" ;;
        "Option2") echo "Selected 2" ;;
        "Quit") break ;;
    esac
done

# Here documents
cat << EOF
Multiple
lines of
text
EOF
```

### Error Handling
```bash
# Exit on error
set -e  # Exit on any error
set -u  # Exit on undefined variable
set -o pipefail  # Exit on pipe failure

# Error handling
command || { echo "Failed"; exit 1; }

# Trap signals
trap 'echo "Interrupted"' INT
trap 'cleanup' EXIT

# Debug mode
set -x  # Print commands
set +x  # Disable debug
```

## Security & Hardening

### File Security
```bash
# File attributes
chattr +i file              # Make immutable
chattr -i file              # Remove immutable
lsattr file                 # List attributes

# Access Control Lists
getfacl file                # Get ACL
setfacl -m u:user:rw file  # Set ACL
setfacl -x u:user file      # Remove ACL

# SELinux (if enabled)
getenforce                  # Get SELinux mode
setenforce 0|1              # Set permissive|enforcing
restorecon -R /path         # Restore context
```

### Security Auditing
```bash
# System auditing
lynis audit system          # Security audit
chkrootkit                  # Rootkit scanner
rkhunter --check            # Rootkit hunter
aide --init                 # Initialize AIDE
aide --check                # Check integrity

# User auditing
last                        # Login history
lastb                       # Failed logins
aureport                    # Audit reports
ausearch -m USER_LOGIN      # Search audit logs
```

### Hardening Commands
```bash
# Disable unnecessary services
systemctl disable service
systemctl mask service

# Kernel parameters
sysctl -a                   # List all parameters
sysctl -w parameter=value   # Set parameter
echo "parameter=value" >> /etc/sysctl.conf

# Secure shared memory
echo "tmpfs /run/shm tmpfs defaults,noexec,nosuid 0 0" >> /etc/fstab

# Password policies
# Edit /etc/pam.d/common-password
# Edit /etc/login.defs
```

## Backup & Recovery

### Backup Tools
```bash
# tar backups
tar -czf backup.tar.gz /path       # Create compressed backup
tar -xzf backup.tar.gz              # Extract backup
tar -tzf backup.tar.gz              # List contents
tar --exclude='*.log' -czf backup.tar.gz /path  # Exclude files

# rsync backups
rsync -avz /source/ /destination/   # Local sync
rsync -avz -e ssh /source/ user@host:/dest/  # Remote sync
rsync -avz --delete /source/ /dest/ # Mirror (deletes extra)
rsync -avz --backup /source/ /dest/ # Keep backups

# dd for disk imaging
dd if=/dev/sda of=disk.img bs=4M   # Create disk image
dd if=disk.img of=/dev/sda bs=4M   # Restore disk image
dd if=/dev/zero of=/dev/sda bs=4M  # Wipe disk

# Backup scripts
#!/bin/bash
DATE=$(date +%Y%m%d)
BACKUP_DIR="/backup"
tar -czf $BACKUP_DIR/backup-$DATE.tar.gz /home /etc
find $BACKUP_DIR -name "backup-*.tar.gz" -mtime +30 -delete
```

### System Recovery
```bash
# Boot recovery
# Boot from live USB/CD
mount /dev/sda1 /mnt               # Mount root partition
mount --bind /dev /mnt/dev
mount --bind /proc /mnt/proc
mount --bind /sys /mnt/sys
chroot /mnt                        # Enter system

# GRUB recovery
update-grub                        # Update GRUB config
grub-install /dev/sda             # Reinstall GRUB

# Package recovery
dpkg --configure -a                # Configure pending
apt-get -f install                # Fix dependencies
apt --fix-broken install          # Fix broken packages
```

## Log Management

### System Logs
```bash
# Log locations
/var/log/syslog     # System log
/var/log/auth.log   # Authentication log
/var/log/kern.log   # Kernel log
/var/log/messages   # General messages
/var/log/dmesg      # Boot messages
/var/log/apt/       # Package manager logs

# Viewing logs
tail -f /var/log/syslog           # Follow log
tail -n 100 /var/log/syslog       # Last 100 lines
grep "error" /var/log/syslog      # Search logs
journalctl -f                     # Follow systemd logs
journalctl -u service             # Service logs
journalctl --since "1 hour ago"   # Time-based
dmesg                             # Kernel messages
```

### Log Rotation
```bash
# Logrotate configuration
/etc/logrotate.conf               # Main config
/etc/logrotate.d/                 # Per-app configs

# Manual rotation
logrotate -f /etc/logrotate.conf  # Force rotation

# Example logrotate config
/var/log/myapp/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 0640 root adm
}
```

### Log Analysis
```bash
# Log parsing
awk '/error/ {print $0}' /var/log/syslog
grep -E "fail|error|critical" /var/log/syslog
sed -n '/START/,/END/p' logfile   # Extract range

# Log monitoring tools
fail2ban-client status            # Fail2ban status
fail2ban-client status sshd       # SSH jail status
logwatch --detail high            # Log summary
```

## DNS Server Configuration

### BIND9 DNS Server
```bash
# Install BIND9
apt install bind9 bind9-utils bind9-doc dnsutils

# Configuration files
/etc/bind/named.conf         # Main configuration
/etc/bind/named.conf.local   # Local zones
/etc/bind/named.conf.options # DNS options
/etc/bind/db.local          # Zone file template

# Basic named.conf.options
options {
    directory "/var/cache/bind";
    recursion yes;
    allow-recursion { localhost; 192.168.1.0/24; };
    forwarders {
        8.8.8.8;
        8.8.4.4;
    };
    dnssec-validation auto;
    listen-on-v6 { any; };
};

# Zone configuration (named.conf.local)
zone "example.com" {
    type master;
    file "/etc/bind/zones/db.example.com";
};

zone "1.168.192.in-addr.arpa" {
    type master;
    file "/etc/bind/zones/db.192.168.1";
};

# Forward zone file (/etc/bind/zones/db.example.com)
$TTL    604800
@       IN      SOA     ns1.example.com. admin.example.com. (
                        2024010101      ; Serial
                        604800          ; Refresh
                        86400           ; Retry
                        2419200         ; Expire
                        604800 )        ; Negative Cache TTL

@       IN      NS      ns1.example.com.
@       IN      NS      ns2.example.com.
@       IN      A       192.168.1.10
@       IN      MX      10 mail.example.com.

ns1     IN      A       192.168.1.10
ns2     IN      A       192.168.1.11
www     IN      A       192.168.1.20
mail    IN      A       192.168.1.30
ftp     IN      CNAME   www.example.com.

# Reverse zone file (/etc/bind/zones/db.192.168.1)
$TTL    604800
@       IN      SOA     ns1.example.com. admin.example.com. (
                        2024010101      ; Serial
                        604800          ; Refresh
                        86400           ; Retry
                        2419200         ; Expire
                        604800 )        ; Negative Cache TTL

@       IN      NS      ns1.example.com.
@       IN      NS      ns2.example.com.

10      IN      PTR     ns1.example.com.
11      IN      PTR     ns2.example.com.
20      IN      PTR     www.example.com.
30      IN      PTR     mail.example.com.

# DNS management commands
named-checkconf                     # Check configuration syntax
named-checkzone example.com /etc/bind/zones/db.example.com
systemctl restart bind9             # Restart DNS server
systemctl status bind9              # Check status
rndc reload                         # Reload zones
rndc flush                          # Flush cache

# Testing DNS
dig @localhost example.com          # Query local DNS
nslookup example.com localhost      # Alternative query
host example.com localhost          # Simple query
dig @localhost -x 192.168.1.10      # Reverse lookup
```

### Dnsmasq (Lightweight Alternative)
```bash
# Install dnsmasq
apt install dnsmasq

# Configuration
/etc/dnsmasq.conf                   # Main config

# Basic dnsmasq.conf
domain-needed
bogus-priv
no-resolv
server=8.8.8.8
server=8.8.4.4
local=/example.com/
address=/example.com/192.168.1.10
address=/www.example.com/192.168.1.20
interface=eth0
listen-address=127.0.0.1,192.168.1.10
cache-size=1000

# Manage dnsmasq
systemctl restart dnsmasq
systemctl enable dnsmasq
```

## Mail Server Setup

### Postfix Mail Server
```bash
# Install Postfix
apt install postfix postfix-doc

# Main configuration files
/etc/postfix/main.cf               # Main configuration
/etc/postfix/master.cf             # Service configuration
/etc/aliases                       # Email aliases

# Basic main.cf configuration
# General settings
myhostname = mail.example.com
mydomain = example.com
myorigin = $mydomain
mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain
mynetworks = 127.0.0.0/8, 192.168.1.0/24
inet_interfaces = all
inet_protocols = ipv4

# Mail routing
relay_domains = $mydestination
relayhost = 
home_mailbox = Maildir/
mailbox_size_limit = 0
recipient_delimiter = +

# Security settings
smtpd_banner = $myhostname ESMTP
smtpd_tls_cert_file=/etc/ssl/certs/mail.pem
smtpd_tls_key_file=/etc/ssl/private/mail.key
smtpd_use_tls=yes
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache

# Restrictions
smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated defer_unauth_destination
smtpd_recipient_restrictions = 
    permit_mynetworks,
    permit_sasl_authenticated,
    reject_unauth_destination,
    reject_rbl_client zen.spamhaus.org,
    reject_rhsbl_reverse_client dbl.spamhaus.org,
    reject_rhsbl_helo dbl.spamhaus.org,
    reject_rhsbl_sender dbl.spamhaus.org

# Postfix management
postfix check                      # Check configuration
postfix reload                     # Reload configuration
postmap /etc/postfix/virtual       # Update virtual maps
newaliases                         # Update aliases
mailq                              # View mail queue
postsuper -d ALL                   # Delete all queued mail
postcat -q QUEUEID                 # View queued message
```

### Dovecot IMAP/POP3 Server
```bash
# Install Dovecot
apt install dovecot-core dovecot-imapd dovecot-pop3d

# Configuration files
/etc/dovecot/dovecot.conf          # Main config
/etc/dovecot/conf.d/               # Modular configs

# Basic configuration
# /etc/dovecot/conf.d/10-mail.conf
mail_location = maildir:~/Maildir
namespace inbox {
    inbox = yes
}

# /etc/dovecot/conf.d/10-auth.conf
disable_plaintext_auth = yes
auth_mechanisms = plain login

# /etc/dovecot/conf.d/10-ssl.conf
ssl = yes
ssl_cert = </etc/ssl/certs/mail.pem
ssl_key = </etc/ssl/private/mail.key

# User authentication
# /etc/dovecot/conf.d/auth-system.conf.ext
passdb {
    driver = pam
}
userdb {
    driver = passwd
}

# Dovecot management
dovecot -n                         # Show configuration
systemctl restart dovecot          # Restart service
doveadm user '*'                   # List users
doveadm auth test username         # Test authentication
```

### Mail Server Security
```bash
# SPF Record (DNS TXT record)
example.com. IN TXT "v=spf1 mx a ip4:192.168.1.30 -all"

# DKIM with OpenDKIM
apt install opendkim opendkim-tools

# Generate DKIM keys
opendkim-genkey -t -s mail -d example.com
mv mail.private /etc/opendkim/keys/
chown opendkim:opendkim /etc/opendkim/keys/mail.private

# DMARC Record (DNS TXT record)
_dmarc.example.com. IN TXT "v=DMARC1; p=quarantine; rua=mailto:dmarc@example.com"

# Anti-spam with SpamAssassin
apt install spamassassin spamc
systemctl enable spamassassin
systemctl start spamassassin

# ClamAV antivirus
apt install clamav clamav-daemon
freshclam                          # Update virus database
systemctl start clamav-daemon
```

## Web Hosting Configuration

### Apache Web Server
```bash
# Install Apache
apt install apache2 apache2-doc apache2-utils

# Configuration structure
/etc/apache2/apache2.conf          # Main configuration
/etc/apache2/sites-available/      # Site configurations
/etc/apache2/sites-enabled/        # Enabled sites
/etc/apache2/mods-available/       # Available modules
/etc/apache2/mods-enabled/         # Enabled modules

# Virtual host configuration
# /etc/apache2/sites-available/example.com.conf
<VirtualHost *:80>
    ServerName example.com
    ServerAlias www.example.com
    ServerAdmin webmaster@example.com
    DocumentRoot /var/www/example.com/public_html
    
    <Directory /var/www/example.com/public_html>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
    
    ErrorLog ${APACHE_LOG_DIR}/example.com-error.log
    CustomLog ${APACHE_LOG_DIR}/example.com-access.log combined
</VirtualHost>

# SSL Virtual host
<VirtualHost *:443>
    ServerName example.com
    DocumentRoot /var/www/example.com/public_html
    
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/example.com.crt
    SSLCertificateKeyFile /etc/ssl/private/example.com.key
    SSLCertificateChainFile /etc/ssl/certs/chain.crt
    
    # Security headers
    Header always set Strict-Transport-Security "max-age=31536000"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
</VirtualHost>

# Apache management
a2ensite example.com               # Enable site
a2dissite 000-default              # Disable site
a2enmod rewrite ssl headers        # Enable modules
a2dismod status                    # Disable module
apache2ctl configtest              # Test configuration
systemctl reload apache2           # Reload configuration
apache2ctl -S                      # Show virtual hosts
```

### Nginx Web Server
```bash
# Install Nginx
apt install nginx nginx-doc

# Configuration structure
/etc/nginx/nginx.conf              # Main configuration
/etc/nginx/sites-available/        # Site configurations
/etc/nginx/sites-enabled/          # Enabled sites
/etc/nginx/snippets/               # Reusable configs

# Virtual host configuration
# /etc/nginx/sites-available/example.com
server {
    listen 80;
    listen [::]:80;
    
    server_name example.com www.example.com;
    root /var/www/example.com/public_html;
    index index.html index.php;
    
    # Logging
    access_log /var/log/nginx/example.com-access.log;
    error_log /var/log/nginx/example.com-error.log;
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    location / {
        try_files $uri $uri/ =404;
    }
    
    # PHP configuration
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php8.2-fpm.sock;
    }
    
    # Deny access to hidden files
    location ~ /\. {
        deny all;
    }
}

# SSL configuration
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    
    server_name example.com www.example.com;
    
    ssl_certificate /etc/ssl/certs/example.com.crt;
    ssl_certificate_key /etc/ssl/private/example.com.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # Rest of configuration...
}

# Nginx management
nginx -t                           # Test configuration
ln -s /etc/nginx/sites-available/example.com /etc/nginx/sites-enabled/
rm /etc/nginx/sites-enabled/default
systemctl reload nginx             # Reload configuration
nginx -T                           # Show full configuration
```

### PHP Configuration
```bash
# Install PHP-FPM
apt install php-fpm php-mysql php-xml php-mbstring php-curl php-gd php-zip

# PHP configuration files
/etc/php/8.2/fpm/php.ini          # PHP-FPM settings
/etc/php/8.2/fpm/pool.d/www.conf  # FPM pool configuration
/etc/php/8.2/cli/php.ini          # CLI settings

# Important php.ini settings
upload_max_filesize = 64M
post_max_size = 64M
max_execution_time = 300
memory_limit = 256M
display_errors = Off
log_errors = On
error_log = /var/log/php_errors.log

# PHP-FPM pool configuration
pm = dynamic
pm.max_children = 50
pm.start_servers = 5
pm.min_spare_servers = 5
pm.max_spare_servers = 35
pm.max_requests = 500

# PHP management
php -v                             # PHP version
php -m                             # Loaded modules
php -i                             # PHP info
systemctl restart php8.2-fpm       # Restart PHP-FPM
```

### Database Server Setup
```bash
# MariaDB/MySQL installation
apt install mariadb-server mariadb-client

# Secure installation
mysql_secure_installation

# Database management
mysql -u root -p                   # Connect to MySQL

# MySQL commands
CREATE DATABASE dbname;
CREATE USER 'username'@'localhost' IDENTIFIED BY 'password';
GRANT ALL PRIVILEGES ON dbname.* TO 'username'@'localhost';
FLUSH PRIVILEGES;
SHOW DATABASES;
SHOW TABLES;
SHOW GRANTS FOR 'username'@'localhost';

# Backup and restore
mysqldump -u root -p dbname > backup.sql
mysql -u root -p dbname < backup.sql
mysqldump -u root -p --all-databases > all_databases.sql

# PostgreSQL installation
apt install postgresql postgresql-contrib

# PostgreSQL management
sudo -u postgres psql              # Connect as postgres
\l                                 # List databases
\du                                # List users
\dt                                # List tables
CREATE DATABASE dbname;
CREATE USER username WITH PASSWORD 'password';
GRANT ALL PRIVILEGES ON DATABASE dbname TO username;
```

### SSL/TLS Certificate Management
```bash
# Let's Encrypt with Certbot
apt install certbot python3-certbot-apache python3-certbot-nginx

# Obtain certificate for Apache
certbot --apache -d example.com -d www.example.com

# Obtain certificate for Nginx
certbot --nginx -d example.com -d www.example.com

# Standalone certificate
certbot certonly --standalone -d example.com

# Certificate renewal
certbot renew --dry-run            # Test renewal
certbot renew                      # Renew certificates

# Auto-renewal cron job
echo "0 3 * * * root certbot renew --quiet" > /etc/cron.d/certbot

# Manual SSL certificate
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
    -keyout /etc/ssl/private/example.key \
    -out /etc/ssl/certs/example.crt
```

### FTP Server Setup
```bash
# Install vsftpd
apt install vsftpd

# Configuration /etc/vsftpd.conf
listen=YES
listen_ipv6=NO
anonymous_enable=NO
local_enable=YES
write_enable=YES
chroot_local_user=YES
allow_writeable_chroot=YES
pasv_enable=YES
pasv_min_port=40000
pasv_max_port=50000
userlist_enable=YES
userlist_file=/etc/vsftpd.userlist
userlist_deny=NO

# SSL/TLS configuration
ssl_enable=YES
rsa_cert_file=/etc/ssl/certs/vsftpd.pem
rsa_private_key_file=/etc/ssl/private/vsftpd.key
force_local_data_ssl=YES
force_local_logins_ssl=YES

# User management
echo "username" >> /etc/vsftpd.userlist
systemctl restart vsftpd

# ProFTPD alternative
apt install proftpd-basic
# Configure in /etc/proftpd/proftpd.conf
```

### Container Services

#### Docker Setup
```bash
# Install Docker
apt install docker.io docker-compose

# Docker management
docker ps                          # Running containers
docker ps -a                       # All containers
docker images                      # List images
docker pull image:tag              # Download image
docker run -d -p 80:80 nginx       # Run container
docker stop container_id           # Stop container
docker rm container_id             # Remove container
docker logs container_id           # View logs
docker exec -it container_id bash  # Enter container

# Docker Compose example
# docker-compose.yml
version: '3'
services:
  web:
    image: nginx
    ports:
      - "80:80"
    volumes:
      - ./html:/usr/share/nginx/html
  db:
    image: mariadb
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: myapp
    volumes:
      - db_data:/var/lib/mysql
volumes:
  db_data:

# Docker Compose commands
docker-compose up -d               # Start services
docker-compose down                # Stop services
docker-compose logs -f             # View logs
docker-compose ps                  # List services
```

### Monitoring and Logging

#### Centralized Logging
```bash
# Rsyslog configuration
# /etc/rsyslog.d/remote.conf
# Server configuration
$ModLoad imudp
$UDPServerRun 514
$template RemoteLogs,"/var/log/remote/%HOSTNAME%/%PROGRAMNAME%.log"
*.* ?RemoteLogs

# Client configuration
*.* @192.168.1.10:514

# ELK Stack setup (basic)
# Elasticsearch
wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | apt-key add -
apt install elasticsearch
systemctl enable elasticsearch

# Logstash
apt install logstash

# Kibana
apt install kibana
systemctl enable kibana
```

## Advanced Techniques

### Text Processing
```bash
# grep variations
grep -r "pattern" /path           # Recursive search
grep -v "pattern" file            # Inverse match
grep -E "regex" file              # Extended regex
grep -P "perl-regex" file         # Perl regex
grep -o "pattern" file            # Only matching part

# sed (stream editor)
sed 's/old/new/g' file            # Replace globally
sed -i 's/old/new/g' file         # In-place edit
sed '1,10d' file                  # Delete lines 1-10
sed -n '5,10p' file               # Print lines 5-10

# awk
awk '{print $1,$3}' file          # Print columns
awk -F: '{print $1}' /etc/passwd  # Custom delimiter
awk 'NR==5' file                  # Print line 5
awk '{sum+=$1} END {print sum}'   # Sum column

# cut
cut -d: -f1 /etc/passwd          # Extract field
cut -c1-10 file                  # Extract characters

# sort and uniq
sort file                        # Sort lines
sort -n file                     # Numeric sort
sort -r file                     # Reverse sort
uniq file                        # Remove duplicates
uniq -c file                     # Count occurrences
```

### Advanced Bash Features
```bash
# Brace expansion
echo {1..10}                     # Number sequence
echo {a..z}                      # Letter sequence
mkdir dir_{01..10}               # Multiple directories

# Parameter expansion
${VAR:-default}                  # Use default if unset
${VAR:=default}                  # Set default if unset
${VAR:?error}                    # Error if unset
${VAR:+value}                    # Use value if set
${#VAR}                          # String length
${VAR:2:5}                       # Substring
${VAR%pattern}                   # Remove suffix
${VAR#pattern}                   # Remove prefix
${VAR//old/new}                  # Replace all

# Process substitution
diff <(command1) <(command2)     # Compare outputs
while read line; do
    echo $line
done < <(command)

# Command grouping
{ command1; command2; } > output  # Group commands
(command1; command2) | command3   # Subshell grouping
```

### Performance Optimization
```bash
# Parallel execution
command1 & command2 & wait        # Run parallel
parallel command ::: arg1 arg2    # GNU parallel
xargs -P 4 -I {} command {} < input  # Parallel xargs

# Caching
# Use memoization in scripts
declare -A cache
function expensive_function() {
    local key="$1"
    if [[ -n "${cache[$key]}" ]]; then
        echo "${cache[$key]}"
        return
    fi
    local result=$(complex_calculation)
    cache[$key]="$result"
    echo "$result"
}
```

### Troubleshooting
```bash
# Debug techniques
bash -x script.sh                # Debug mode
set -x                          # Enable debug
set +x                          # Disable debug
trap 'echo "Line $LINENO"' DEBUG # Trace execution

# System recovery
init 1                          # Single user mode
fsck /dev/sda1                  # Filesystem check
mount -o remount,rw /           # Remount read-write

# Memory issues
sync && echo 3 > /proc/sys/vm/drop_caches  # Clear cache
swapoff -a && swapon -a         # Reset swap

# Network troubleshooting
ip link set dev eth0 down && ip link set dev eth0 up
dhclient -r && dhclient         # Renew DHCP
```

## Kali Linux Specific

### Kali Tools Integration
```bash
# Update Kali tools
apt update && apt install kali-linux-large

# Common tool locations
/usr/share/wordlists/           # Wordlists
/usr/share/nmap/                # Nmap scripts
/usr/share/metasploit-framework/ # Metasploit
/usr/share/webshells/           # Web shells

# Tool management
searchsploit keyword            # Search exploits
msfconsole                      # Metasploit console
armitage                        # Metasploit GUI
```

### Security Testing Automation
```bash
#!/bin/bash
# Basic recon script
TARGET=$1
echo "[+] Starting recon on $TARGET"

# DNS enumeration
echo "[+] DNS Enumeration"
host $TARGET
dig $TARGET ANY

# Port scanning
echo "[+] Port Scanning"
nmap -sV -sC -oA nmap_$TARGET $TARGET

# Web enumeration (if applicable)
echo "[+] Web Enumeration"
nikto -h http://$TARGET
dirb http://$TARGET
```

## Best Practices

### Script Security
- Always validate input
- Use quotes around variables
- Set strict mode (set -euo pipefail)
- Avoid eval and source with untrusted input
- Use absolute paths in scripts
- Set appropriate permissions

### Performance Tips
- Use built-in commands over external programs
- Minimize subshell creation
- Cache results when possible
- Use appropriate data structures
- Profile before optimizing

### Maintenance
- Regular system updates
- Monitor logs regularly
- Automate repetitive tasks
- Document your scripts
- Version control configurations
- Test in non-production first

## Quick Reference Card

### Essential One-Liners
```bash
# Find and replace in files
find . -type f -exec sed -i 's/old/new/g' {} +

# Monitor log file for pattern
tail -f /var/log/syslog | grep --line-buffered "pattern"

# Backup with progress
rsync -avh --progress /source/ /destination/

# Find large files
find / -xdev -type f -size +100M -exec ls -lh {} \;

# Clean package cache
apt clean && apt autoclean && apt autoremove

# Show listening ports with programs
ss -tlnp

# Quick system overview
echo "CPU: $(nproc) cores" && free -h && df -h

# Find files modified in last 24 hours
find /path -mtime -1 -type f

# Create secure password
openssl rand -base64 32

# Quick HTTP server
python3 -m http.server 8080

# Test mail server
echo "Test email" | mail -s "Test Subject" user@example.com

# Check DNS resolution
dig +short example.com @8.8.8.8

# Quick SSL certificate check
openssl s_client -connect example.com:443 -servername example.com < /dev/null

# Monitor Apache connections
watch -n 1 'netstat -an | grep :80 | wc -l'

# MySQL process list
mysql -e "SHOW PROCESSLIST" | grep -v Sleep

# Find PHP errors
tail -f /var/log/apache2/error.log | grep -i php

# Check mail queue
postqueue -p

# Test SMTP server
telnet localhost 25

# Quick backup all databases
mysqldump --all-databases > all_dbs_$(date +%Y%m%d).sql

# Monitor disk I/O
iostat -x 1

# Check service dependencies
systemctl list-dependencies service_name

# Find broken symbolic links
find / -xtype l -print

# Monitor network connections by service
ss -tanp | grep ESTABLISHED

# Quick security audit
lynis audit system --quick

# Generate dhparam file
openssl dhparam -out /etc/ssl/dhparam.pem 2048

# Test web server headers
curl -I https://example.com

# Monitor system calls of a process
strace -p $(pidof process_name)

# Check certificate expiration
echo | openssl s_client -connect example.com:443 2>/dev/null | openssl x509 -noout -dates

# Batch rename files
for f in *.txt; do mv "$f" "${f%.txt}.bak"; done

# Monitor CPU temperature
watch -n 1 'sensors | grep Core'

# Quick port scan
nc -zv localhost 1-1000 2>&1 | grep succeeded

# Extract IP addresses from log
grep -oE '\b([0-9]{1,3}\.){3}[0-9]{1,3}\b' /var/log/apache2/access.log | sort | uniq -c

# Check systemd boot time
systemd-analyze blame

# Find duplicate files
find . -type f -exec md5sum {} + | sort | uniq -w32 -dD
```

### Common Server Configurations Summary

#### DNS Server Quick Setup
```bash
# BIND9 quick setup
apt install bind9
echo 'zone "example.com" { type master; file "/etc/bind/db.example.com"; };' >> /etc/bind/named.conf.local
cp /etc/bind/db.local /etc/bind/db.example.com
# Edit /etc/bind/db.example.com with your records
systemctl restart bind9
```

#### Mail Server Quick Setup
```bash
# Postfix + Dovecot quick setup
apt install postfix dovecot-core dovecot-imapd
postconf -e "mydomain = example.com"
postconf -e "home_mailbox = Maildir/"
systemctl restart postfix dovecot
```

#### Web Server Quick Setup
```bash
# Nginx + PHP quick setup
apt install nginx php-fpm
# Create site config in /etc/nginx/sites-available/
ln -s /etc/nginx/sites-available/site /etc/nginx/sites-enabled/
systemctl restart nginx php*-fpm
```

#### SSL Quick Setup
```bash
# Let's Encrypt quick setup
apt install certbot python3-certbot-nginx
certbot --nginx -d example.com
echo "0 3 * * * root certbot renew --quiet" > /etc/cron.d/certbot
```

### Emergency Commands

#### System Recovery
```bash
# Boot to single user mode
# Add 'single' or '1' to kernel boot parameters

# Reset root password
mount -o remount,rw /
passwd root

# Fix broken packages
dpkg --configure -a
apt --fix-broken install

# Rebuild initramfs
update-initramfs -u

# Fix filesystem
fsck -y /dev/sda1

# Emergency network config
ip addr add 192.168.1.10/24 dev eth0
ip route add default via 192.168.1.1
echo "nameserver 8.8.8.8" > /etc/resolv.conf
```

#### Service Recovery
```bash
# MySQL won't start
mkdir -p /var/run/mysqld
chown mysql:mysql /var/run/mysqld
mysqld_safe --skip-grant-tables &
mysql -e "FLUSH PRIVILEGES;"

# Apache won't start
apache2ctl configtest
journalctl -xe | grep apache

# Clear mail queue
postsuper -d ALL

# Reset fail2ban bans
fail2ban-client unban --all
```

### Performance Monitoring Dashboard
```bash
#!/bin/bash
# Simple monitoring script
while true; do
    clear
    echo "=== System Monitor - $(date) ==="
    echo
    echo "--- CPU & Memory ---"
    top -bn1 | head -5
    echo
    echo "--- Disk Usage ---"
    df -h | grep -E '^/dev/'
    echo
    echo "--- Network Connections ---"
    ss -s
    echo
    echo "--- Top Processes ---"
    ps aux --sort=-%cpu | head -6
    sleep 5
done
```

### Backup Script Template
```bash
#!/bin/bash
# Complete backup script

# Configuration
BACKUP_DIR="/backup"
MYSQL_USER="backup"
MYSQL_PASS="password"
RETENTION_DAYS=30
DATE=$(date +%Y%m%d_%H%M%S)
LOG_FILE="$BACKUP_DIR/backup_$DATE.log"

# Create backup directory
mkdir -p $BACKUP_DIR

# Function to log messages
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a $LOG_FILE
}

# Start backup
log "Starting backup..."

# Backup system files
log "Backing up system files..."
tar -czf $BACKUP_DIR/system_$DATE.tar.gz \
    /etc \
    /var/www \
    /home \
    --exclude='*.log' \
    --exclude='*/cache/*' 2>>$LOG_FILE

# Backup MySQL databases
log "Backing up MySQL databases..."
mysqldump -u$MYSQL_USER -p$MYSQL_PASS \
    --all-databases \
    --single-transaction \
    --quick \
    --lock-tables=false > $BACKUP_DIR/mysql_$DATE.sql 2>>$LOG_FILE

gzip $BACKUP_DIR/mysql_$DATE.sql

# Backup mail
log "Backing up mail..."
tar -czf $BACKUP_DIR/mail_$DATE.tar.gz /var/mail 2>>$LOG_FILE

# Clean old backups
log "Cleaning old backups..."
find $BACKUP_DIR -name "*.tar.gz" -mtime +$RETENTION_DAYS -delete
find $BACKUP_DIR -name "*.sql.gz" -mtime +$RETENTION_DAYS -delete

# Sync to remote server (optional)
# rsync -avz $BACKUP_DIR/ user@remote:/backup/

log "Backup completed!"

# Send notification (optional)
# echo "Backup completed at $(date)" | mail -s "Backup Report" admin@example.com
```

### Security Checklist
```bash
# Regular security tasks checklist

# 1. Update system
apt update && apt upgrade

# 2. Check for rootkits
rkhunter --check
chkrootkit

# 3. Review user accounts
awk -F: '($3 >= 1000) {print $1}' /etc/passwd
lastlog | grep -v "Never"

# 4. Check sudo access
grep -v '^#' /etc/sudoers | grep -v '^

# 5. Review open ports
ss -tlnp
lsof -i -P -n

# 6. Check for suspicious processes
ps auxf | less
htop

# 7. Review system logs
grep -i "failed\|error\|attack" /var/log/syslog
journalctl -p err -b

# 8. Check file integrity
aide --check
debsums -c

# 9. Review firewall rules
iptables -L -n -v
ufw status verbose

# 10. Check SSL certificates
find /etc/ssl -name "*.crt" -exec openssl x509 -noout -dates -in {} \; -print

# 11. Review cron jobs
for user in $(cut -f1 -d: /etc/passwd); do 
    echo "=== $user ==="
    crontab -u $user -l 2>/dev/null
done

# 12. Check disk space
df -h
du -sh /* | sort -h

# 13. Review SSH configuration
sshd -T | grep -E "permitrootlogin|passwordauthentication|port"

# 14. Check for world-writable files
find / -xdev -type f -perm -0002 -ls 2>/dev/null

# 15. Review running services
systemctl list-units --type=service --state=running
```

### Troubleshooting Guide

#### Network Issues
```bash
# No network connectivity
ip link show                      # Check interfaces
ip addr show                      # Check IP addresses
ip route show                     # Check routing
cat /etc/resolv.conf             # Check DNS
ping -c 4 8.8.8.8                # Test connectivity
ping -c 4 google.com             # Test DNS
traceroute google.com            # Trace route
mtr google.com                   # Interactive trace

# Slow network
iftop -i eth0                    # Monitor bandwidth
nethogs                          # Per-process bandwidth
tcpdump -i eth0 -n              # Packet analysis
netstat -s                       # Network statistics
```

#### Disk Issues
```bash
# Disk full
df -h                            # Check disk usage
df -i                            # Check inode usage
du -sh /* | sort -h              # Find large directories
find / -xdev -size +100M -ls     # Find large files
lsof | grep deleted              # Find deleted but open files

# Disk I/O issues
iostat -x 1                      # I/O statistics
iotop                            # I/O by process
hdparm -tT /dev/sda              # Test disk speed
smartctl -a /dev/sda             # SMART status
```

#### Memory Issues
```bash
# High memory usage
free -h                          # Memory overview
ps aux --sort=-%mem | head       # Top memory users
pmap -x PID                      # Process memory map
vmstat 1                         # Virtual memory stats
slabtop                          # Kernel slab allocator

# Clear caches
sync && echo 3 > /proc/sys/vm/drop_caches
swapoff -a && swapon -a          # Reset swap
```

#### Service Issues
```bash
# Service won't start
systemctl status service_name     # Check status
journalctl -u service_name -n 50  # Check logs
systemctl list-dependencies service_name  # Check deps
ldd /path/to/binary              # Check libraries

# Port already in use
lsof -i :PORT                    # Find process using port
fuser -v PORT/tcp                # Alternative method
ss -tlnp | grep PORT             # Socket statistics
```

---

This completes the comprehensive Bash guide for system administrators on Kali Linux, now including:
- DNS server configuration (BIND9 and dnsmasq)
- Mail server setup (Postfix, Dovecot, security)
- Web hosting (Apache, Nginx, PHP, SSL)
- Database servers (MySQL/MariaDB, PostgreSQL)
- FTP servers
- Container services (Docker)
- Load balancing and high availability
- Automation tools
- Cloud integration
- VPN setup
- Virtualization
- Advanced security configurations
- Performance tuning
- Emergency recovery procedures
- Complete backup solutions
- Security checklists
- Troubleshooting guides

The guide now covers virtually all aspects of Linux system administration, from basic commands to complex server configurations and enterprise-level solutions.
