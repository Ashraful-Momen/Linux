# Complete UFW (Uncomplicated Firewall) Guide

## Table of Contents
1. [Installation & Basic Setup](#installation--basic-setup)
2. [Default Policies](#default-policies)
3. [Allowing Traffic](#allowing-traffic)
4. [Denying/Blocking Traffic](#denyingblocking-traffic)
5. [Managing Rules](#managing-rules)
6. [Advanced Rules](#advanced-rules)
7. [Application Profiles](#application-profiles)
8. [Logging & Monitoring](#logging--monitoring)
9. [Troubleshooting](#troubleshooting)
10. [Best Practices](#best-practices)

---

## Installation & Basic Setup

### Install UFW
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install ufw

# Check if already installed
sudo ufw --version
```

### Basic Commands
```bash
# Check status
sudo ufw status
sudo ufw status verbose
sudo ufw status numbered

# Enable/Disable UFW
sudo ufw enable
sudo ufw disable

# Reset all rules (careful!)
sudo ufw --force reset
```

---

## Default Policies

### Set Default Policies
```bash
# Deny all incoming connections
sudo ufw default deny incoming

# Allow all outgoing connections
sudo ufw default allow outgoing

# Deny forwarded connections (for routers)
sudo ufw default deny routed

# View current defaults
sudo ufw status verbose
```

---

## Allowing Traffic

### Allow by Port
```bash
# Allow specific port
sudo ufw allow 22          # SSH
sudo ufw allow 80          # HTTP
sudo ufw allow 443         # HTTPS
sudo ufw allow 25          # SMTP
sudo ufw allow 3306        # MySQL

# Allow port with protocol
sudo ufw allow 22/tcp      # SSH over TCP
sudo ufw allow 53/udp      # DNS over UDP
sudo ufw allow 1194/udp    # OpenVPN

# Allow port ranges
sudo ufw allow 6000:6007/tcp
sudo ufw allow 1000:2000/udp
```

### Allow by Service Name
```bash
# Common services
sudo ufw allow ssh
sudo ufw allow http
sudo ufw allow https
sudo ufw allow ftp
sudo ufw allow smtp
sudo ufw allow pop3
sudo ufw allow imap

# List available services
sudo ufw app list
```

### Allow from Specific IP Addresses
```bash
# Allow from single IP
sudo ufw allow from 192.168.1.100
sudo ufw allow from 203.0.113.4

# Allow from IP to specific port
sudo ufw allow from 192.168.1.100 to any port 22
sudo ufw allow from 203.0.113.4 to any port 3306

# Allow from IP with protocol
sudo ufw allow from 192.168.1.100 to any port 22 proto tcp
```

### Allow from IP Ranges/Subnets
```bash
# Allow from subnet
sudo ufw allow from 192.168.1.0/24
sudo ufw allow from 10.0.0.0/8
sudo ufw allow from 172.16.0.0/12

# Allow from subnet to specific port
sudo ufw allow from 192.168.1.0/24 to any port 80
sudo ufw allow from 10.0.0.0/8 to any port 443
```

### Allow on Specific Interface
```bash
# Allow on specific network interface
sudo ufw allow in on eth0 to any port 80
sudo ufw allow in on wlan0 to any port 22
sudo ufw allow out on eth1 to any port 25
```

### Allow Between Specific IPs
```bash
# Allow from specific IP to specific destination
sudo ufw allow from 192.168.1.100 to 192.168.1.200 port 3306
sudo ufw allow from 10.0.0.5 to 10.0.0.10 port 5432
```

---

## Denying/Blocking Traffic

### Deny by Port
```bash
# Deny specific port
sudo ufw deny 23          # Telnet
sudo ufw deny 135         # Windows RPC
sudo ufw deny 139         # NetBIOS

# Deny with protocol
sudo ufw deny 23/tcp
sudo ufw deny 161/udp     # SNMP

# Deny port ranges
sudo ufw deny 135:139/tcp
sudo ufw deny 4000:4010/udp
```

### Deny from Specific IP Addresses
```bash
# Block single IP completely
sudo ufw deny from 192.168.1.50
sudo ufw deny from 203.0.113.100

# Block IP from accessing specific port
sudo ufw deny from 192.168.1.50 to any port 80
sudo ufw deny from 203.0.113.100 to any port 443

# Block with protocol
sudo ufw deny from 192.168.1.50 to any port 22 proto tcp
```

### Deny from IP Ranges/Subnets
```bash
# Block entire subnets
sudo ufw deny from 192.168.2.0/24
sudo ufw deny from 172.16.0.0/16

# Block subnet from specific port
sudo ufw deny from 192.168.2.0/24 to any port 80
```

### Reject vs Deny
```bash
# DENY (default - drops packets silently)
sudo ufw deny from 192.168.1.50

# REJECT (sends back error message)
sudo ufw reject from 192.168.1.50
sudo ufw reject out 25  # Reject outgoing SMTP
```

---

## Managing Rules

### View Rules
```bash
# Basic status
sudo ufw status

# Verbose status (shows defaults and logging)
sudo ufw status verbose

# Numbered list (for deletion)
sudo ufw status numbered
```

### Delete Rules
```bash
# Delete by rule number
sudo ufw status numbered
sudo ufw delete 3

# Delete by specifying the rule
sudo ufw delete allow 80
sudo ufw delete allow from 192.168.1.100
sudo ufw delete deny from 203.0.113.4 to any port 22

# Delete all rules for specific service
sudo ufw delete allow ssh
sudo ufw delete allow 'Nginx Full'
```

### Modify Rules
```bash
# You cannot modify rules directly
# You must delete and recreate them

# Example: Change allowed IP
sudo ufw delete allow from 192.168.1.100 to any port 22
sudo ufw allow from 192.168.1.101 to any port 22
```

### Insert Rules at Specific Position
```bash
# Insert rule at specific position
sudo ufw insert 1 allow from 192.168.1.100
sudo ufw insert 2 deny from 203.0.113.4

# Rules are processed in order, so position matters
```

---

## Advanced Rules

### Rate Limiting
```bash
# Rate limit connections (default: 6 connections in 30 seconds)
sudo ufw limit ssh
sudo ufw limit 22/tcp

# Custom rate limiting (requires manual iptables)
# UFW's limit is basic - for advanced rate limiting, use iptables directly
```

### Direction-Specific Rules
```bash
# Incoming rules (default if not specified)
sudo ufw allow in 80
sudo ufw deny in from 192.168.1.50

# Outgoing rules
sudo ufw allow out 25        # Allow outgoing SMTP
sudo ufw deny out 80         # Block outgoing HTTP
sudo ufw allow out on eth0 to 8.8.8.8 port 53  # Allow DNS to Google
```

### Interface-Specific Rules
```bash
# Rules for specific network interfaces
sudo ufw allow in on eth0 to any port 80
sudo ufw allow in on wlan0 from 192.168.1.0/24
sudo ufw deny in on eth1 from any to any

# Forward rules (for routing/NAT)
sudo ufw route allow in on eth0 out on eth1
sudo ufw route deny in on wlan0 out on eth0
```

### Complex Rules
```bash
# Multiple conditions
sudo ufw allow from 192.168.1.0/24 to 192.168.1.10 port 3306 proto tcp
sudo ufw allow in on eth0 from 10.0.0.0/8 to any port 443 proto tcp

# Allow established connections
# (UFW handles this automatically for allowed connections)

# Log specific rules
sudo ufw allow log 22
sudo ufw deny log from 192.168.1.50
```

---

## Application Profiles

### List Available Profiles
```bash
# List all application profiles
sudo ufw app list

# Get info about specific profile
sudo ufw app info 'Nginx Full'
sudo ufw app info OpenSSH
sudo ufw app info Apache
```

### Common Application Profiles
```bash
# Web servers
sudo ufw allow 'Nginx Full'      # HTTP + HTTPS
sudo ufw allow 'Nginx HTTP'      # HTTP only
sudo ufw allow 'Nginx HTTPS'     # HTTPS only
sudo ufw allow 'Apache Full'     # HTTP + HTTPS
sudo ufw allow 'Apache Secure'   # HTTPS only

# SSH
sudo ufw allow OpenSSH

# FTP
sudo ufw allow vsftpd

# Mail servers
sudo ufw allow Postfix
sudo ufw allow 'Postfix SMTPS'
sudo ufw allow 'Postfix Submission'

# Database servers
sudo ufw allow 'MySQL'
sudo ufw allow 'PostgreSQL'
```

### Create Custom Application Profiles
```bash
# Create custom profile file
sudo nano /etc/ufw/applications.d/myapp

# Example content:
[MyApp]
title=My Custom Application
description=Custom app on port 8080
ports=8080/tcp

[MyApp SSL]
title=My Custom Application with SSL
description=Custom app with HTTP and HTTPS
ports=8080,8443/tcp

# Update profile database
sudo ufw app update myapp

# Use the profile
sudo ufw allow MyApp
```

---

## Logging & Monitoring

### Enable/Configure Logging
```bash
# Enable logging
sudo ufw logging on

# Set logging level
sudo ufw logging low     # Default
sudo ufw logging medium  # More detailed
sudo ufw logging high    # Very detailed
sudo ufw logging full    # Everything

# Disable logging
sudo ufw logging off
```

### View Logs
```bash
# Main UFW log
sudo tail -f /var/log/ufw.log

# System log (includes UFW entries)
sudo tail -f /var/log/syslog | grep UFW

# Search for specific IP
sudo grep "192.168.1.50" /var/log/ufw.log

# Search for blocked connections
sudo grep "BLOCK" /var/log/ufw.log

# Search for allowed connections
sudo grep "ALLOW" /var/log/ufw.log
```

### Log Analysis Examples
```bash
# Find most blocked IPs
sudo awk '/BLOCK/ {print $12}' /var/log/ufw.log | sort | uniq -c | sort -nr | head -10

# Find blocked ports
sudo awk '/BLOCK/ {print $10}' /var/log/ufw.log | sort | uniq -c | sort -nr

# Today's blocked attempts
sudo grep "$(date '+%b %d')" /var/log/ufw.log | grep BLOCK
```

---

## Troubleshooting

### Common Issues

#### SSH Lockout Prevention
```bash
# Always test SSH before disconnecting
# Keep current session open while making changes

# Allow SSH first before enabling UFW
sudo ufw allow 22
sudo ufw enable

# Or allow from your IP only
sudo ufw allow from YOUR_IP to any port 22
```

#### Docker/Container Issues
```bash
# Docker bypasses UFW by default
# Edit /etc/docker/daemon.json
{
  "iptables": false
}
# Then restart Docker
sudo systemctl restart docker

# Or use Docker with host networking
docker run --network host myimage
```

#### Rule Order Issues
```bash
# Rules are processed in order
# More specific rules should come first
sudo ufw insert 1 allow from 192.168.1.100 to any port 22
sudo ufw allow 22  # This would be processed after the above
```

### Debugging Commands
```bash
# Show raw iptables rules
sudo iptables -L -n -v

# Show UFW status with rule numbers
sudo ufw status numbered

# Dry run (test without applying)
sudo ufw --dry-run enable

# Check UFW version and help
sudo ufw version
sudo ufw --help
```

### Emergency Access
```bash
# If locked out, from console/physical access:
sudo ufw disable
sudo ufw --force reset
sudo ufw allow 22
sudo ufw enable

# Or modify iptables directly
sudo iptables -I INPUT -p tcp --dport 22 -j ACCEPT
```

---

## Best Practices

### Security Best Practices
```bash
# 1. Default deny, explicit allow
sudo ufw default deny incoming
sudo ufw default allow outgoing

# 2. Allow only necessary services
sudo ufw allow 22    # SSH
sudo ufw allow 80    # HTTP
sudo ufw allow 443   # HTTPS

# 3. Restrict SSH access
sudo ufw allow from YOUR_IP to any port 22
sudo ufw deny 22  # Deny from all other IPs

# 4. Use non-standard ports when possible
# Change SSH to port 2222, then:
sudo ufw allow 2222
sudo ufw deny 22

# 5. Enable logging
sudo ufw logging on

# 6. Regular rule review
sudo ufw status numbered
```

### Maintenance Commands
```bash
# Regular maintenance script
#!/bin/bash
echo "=== UFW Status ==="
sudo ufw status numbered

echo "=== Recent Blocks ==="
sudo tail -20 /var/log/ufw.log | grep BLOCK

echo "=== Top Blocked IPs ==="
sudo awk '/BLOCK/ {print $12}' /var/log/ufw.log | sort | uniq -c | sort -nr | head -5
```

### Common Rule Sets

#### Web Server
```bash
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow 22        # SSH
sudo ufw allow 80        # HTTP
sudo ufw allow 443       # HTTPS
sudo ufw enable
```

#### Database Server
```bash
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow from APP_SERVER_IP to any port 22    # SSH from app server
sudo ufw allow from APP_SERVER_IP to any port 3306  # MySQL from app server
sudo ufw enable
```

#### Development Server
```bash
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow from 192.168.1.0/24 to any port 22   # SSH from local network
sudo ufw allow from 192.168.1.0/24 to any port 80   # HTTP from local network
sudo ufw allow from 192.168.1.0/24 to any port 3000 # Dev server from local network
sudo ufw enable
```

